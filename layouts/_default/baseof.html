<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ if .IsHome }}{{ .Site.Title }}{{ else }}{{ .Title }} | {{ .Site.Title }}{{ end }}</title>
    <meta name="description" content="{{ if .Description }}{{ .Description }}{{ else }}{{ .Site.Params.description }}{{ end }}">
    {{ partial "cloudbase-init.html" . }}
    <script>
      (function(){
        try {
          var isLocal = (location.hostname === '127.0.0.1' || location.hostname === 'localhost');
          var localEndpoint = 'http://127.0.0.1:3000/auth';
          // 允许通过站点配置覆盖（生产环境）
          var configured = {{ if .Site.Params.cloudbase.authEndpoint }}"{{ .Site.Params.cloudbase.authEndpoint }}"{{ else }}""{{ end }};
          if (isLocal) {
            window.cloudbaseAuthEndpoint = localEndpoint;
            window.cloudbaseCustomTicketEndpoint = localEndpoint;
          } else if (configured) {
            window.cloudbaseAuthEndpoint = configured;
          }
        } catch(_) {}
      })();
    </script>
    <!-- 访问控制配置（JSON，避免IDE误报JS语法） -->
    <script type="application/json" id="access-control-config">{
      "enabled": {{ .Site.Params.accessControl.enabled }},
      "persistentAccess": {{ .Site.Params.accessControl.persistentAccess }},
      "users": {
        "admin": {"password":"admin2024","role":"admin","permissions":["read","write","delete","admin"]},
        "editor": {"password":"editor2024","role":"editor","permissions":["read","write"]},
        "reader": {"password":"reader2024","role":"reader","permissions":["read"]}
      },
      "defaultAccessKey": "{{ .Site.Params.accessControl.accessKey }}",
      "defaultRole": "reader",
      "jwtSecret": "",
      "jwtExpiration": 86400000,
      "whitelistPaths": ["/login/","/about/"]
    }</script>
    <!-- 增强的访问控制系统 -->
    <script>
        // 访问控制配置（从JSON加载，避免IDE误报JS语法）
        (function(){
            try {
                const el = document.getElementById('access-control-config');
                const cfg = el ? JSON.parse(el.textContent) : {};
                window.accessControl = window.accessControl || cfg;
            } catch (e) {
                console.warn('Failed to parse access-control-config JSON', e);
                window.accessControl = window.accessControl || {};
            }
        })();
        const accessControl = window.accessControl;

        // 同步读取本地缓存用户（用于 UI gating / 权限遮挡）
        function getLocalUser() {
            try {
                const str = localStorage.getItem('currentUser');
                return str ? JSON.parse(str) : null;
            } catch(_) { return null; }
        }



        // 获取当前用户（CloudBase 2.x 异步）
        async function getCurrentUser() {
            try {
                const str = localStorage.getItem('currentUser');
                if (str) { try { return JSON.parse(str); } catch(_) {} }
                const auth = window.cloudbaseAuth;
                if (!auth || typeof auth.getCurrentUser !== 'function') return null;
                const cu = await auth.getCurrentUser();
                if (!cu) return null;
                const role = cu.uid === 'admin' ? 'admin' : 'reader';
                const permissions = role === 'admin' ? ['read','write','delete','admin'] : ['read'];
                const user = { uid: cu.uid, email: cu.email || '', role, permissions };
                try { localStorage.setItem('currentUser', JSON.stringify(user)); } catch(_) {}
                return user;
            } catch (e) {
                console.warn('CloudBase 当前用户获取失败:', e);
                return null;
            }
        }

        // 检查访问权限（CloudBase 版）
        function checkAccess() {
            const path = window.location.pathname;
            const wl = Array.isArray(accessControl.whitelistPaths) ? accessControl.whitelistPaths : [];
            for (const whitelistPath of wl) {
                if (path.startsWith(whitelistPath)) { return true; }
            }
            const user = getLocalUser();
            return !!(user && user.uid);
        }



        // 清除访问权限（CloudBase 版）
        function clearAccess() {
            try {
                const auth = window.cloudbaseAuth;
                if (auth && typeof auth.signOut === 'function') {
                    auth.signOut();
                }
            } catch(e) { console.warn('CloudBase signOut 失败:', e); }
            window.__CURRENT_USER__ = null;
            try {
                localStorage.removeItem('novelAccessVerified');
                localStorage.removeItem('hasAccess');
                localStorage.removeItem('currentUser');
            } catch(_) {}
        }

        // 检查用户是否有特定权限（CloudBase 版）
        function hasPermission(permission) {
            const user = getLocalUser();
            if (!user) return false;
            if (user.role === 'admin') return true;
            return Array.isArray(user.permissions) && user.permissions.includes(permission);
        }

        // 统一：确保已加载 CloudBase 用户档案（含角色/权限）
        async function ensureUserProfile() {
            try {
                const auth = window.cloudbaseAuth;
                const db = window.cloudbaseDb;
                if (!auth || !db || typeof auth.getCurrentUser !== 'function') return;
                const cu = await auth.getCurrentUser();
                if (!cu) return;
                const usersCol = (window.cloudbaseCollections && window.cloudbaseCollections.users) || 'users';
                let doc = null;
                try {
                    // 以 uid 作为主键，若不存在则创建默认 reader 档案
                    const res = await db.collection(usersCol).doc(cu.uid).get();
                    if (res && res.data && res.data.length) {
                        doc = res.data[0];
                    } else {
                        const role = 'reader';
                        const permissions = ['read'];
                        await db.collection(usersCol).doc(cu.uid).set({ uid: cu.uid, email: cu.email || '', role, permissions, createdAt: Date.now() });
                        doc = { uid: cu.uid, email: cu.email || '', role, permissions };
                    }
                } catch (e) {
                    console.warn('读取/初始化用户档案失败，使用默认 reader：', e);
                    doc = { uid: cu.uid, email: cu.email || '', role: 'reader', permissions: ['read'] };
                }
                try { localStorage.setItem('currentUser', JSON.stringify(doc)); } catch(_) {}
            } catch (e) {
                console.warn('ensureUserProfile 失败:', e);
            }
        }

        document.addEventListener('DOMContentLoaded', function(){
            ensureUserProfile();
        });

        // 显示用户信息
        function showUserInfo() {
            const user = getLocalUser();
            if (!user) {
                return;
            }
            const userInfo = document.createElement('div');
            userInfo.style.position = 'fixed';
            userInfo.style.top = '16px';
            userInfo.style.right = '16px';
            userInfo.style.padding = '10px 12px';
            userInfo.style.backgroundColor = 'var(--card-bg-color, #f9f9f9)';
            userInfo.style.borderRadius = '4px';
            userInfo.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
            userInfo.style.display = 'flex';
            userInfo.style.alignItems = 'center';
            userInfo.style.gap = '8px';

            const roleSpan = document.createElement('span');
            roleSpan.textContent = `角色: ${user.role}`;
            roleSpan.style.color = 'var(--text-color, #333)';
            roleSpan.style.fontSize = '0.875rem';

            const nicknameSpan = document.createElement('span');
            nicknameSpan.textContent = '昵称: (加载中)';
            nicknameSpan.style.color = 'var(--text-color, #333)';
            nicknameSpan.style.fontSize = '0.875rem';

            const editNickBtn = document.createElement('button');
            editNickBtn.textContent = '改昵称';
            editNickBtn.style.padding = '4px 8px';
            editNickBtn.style.backgroundColor = '#3498db';
            editNickBtn.style.color = 'white';
            editNickBtn.style.border = 'none';
            editNickBtn.style.borderRadius = '4px';
            editNickBtn.style.fontSize = '0.75rem';
            editNickBtn.style.cursor = 'pointer';
            editNickBtn.addEventListener('click', async function() {
                const nn = prompt('输入新的昵称（不超过64字符）');
                if (!nn) return;
                try {
                    const auth = window.cloudbaseAuth;
                    const db = window.cloudbaseDb;
                    if (!auth || !db || typeof auth.getCurrentUser !== 'function') {
                        alert('未登录，无法修改昵称');
                        return;
                    }
                    const cu = await auth.getCurrentUser();
                    const usersCol = (window.cloudbaseCollections && window.cloudbaseCollections.users) || 'users';
                    await db.collection(usersCol).doc(cu.uid).update({
                        nickname: nn,
                        updatedAt: Date.now()
                    });
                    try {
                        const cur = getLocalUser();
                        if (cur) { cur.nickname = nn; localStorage.setItem('currentUser', JSON.stringify(cur)); }
                    } catch(_) {}
                    nicknameSpan.textContent = `昵称: ${nn}`;
                } catch (e) { alert(e.message || '更新失败'); }
            });

            const changePwdBtn = document.createElement('button');
            changePwdBtn.textContent = '改密码';
            changePwdBtn.style.padding = '4px 8px';
            changePwdBtn.style.backgroundColor = '#f39c12';
            changePwdBtn.style.color = 'white';
            changePwdBtn.style.border = 'none';
            changePwdBtn.style.borderRadius = '4px';
            changePwdBtn.style.fontSize = '0.75rem';
            changePwdBtn.style.cursor = 'pointer';
            changePwdBtn.addEventListener('click', async function() {
                try {
                    const oldPassword = prompt('输入原密码');
                    if (!oldPassword) return;
                    const newPassword = prompt('输入新密码');
                    if (!newPassword) return;
                    const u = getLocalUser();
                    if (!u || !u.uid) { alert('未登录，不能改密'); return; }
                    const envId = window.CLOUDBASE_ENV_ID;
                    let endpoint = window.cloudbaseAuthEndpoint || window.cloudbaseCustomTicketEndpoint;
                    if (!endpoint && envId) { endpoint = `https://${envId}.ap-shanghai.app.tcloudbase.com/auth`; }
                    if (!endpoint) { alert('登录接口未配置，请设置 window.cloudbaseAuthEndpoint 或 cloudbaseCustomTicketEndpoint'); return; }
                    const res = await fetch(endpoint, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'changePassword', data: { username: u.uid, oldPassword, newPassword } })
                    });
                    const data = await res.json();
                    if (data && data.success) {
                        alert('密码修改成功，请重新登录');
                        try { await window.cloudbaseAuth.signOut(); } catch(_){}
                        localStorage.removeItem('currentUser');
                        location.reload();
                    } else {
                        alert('修改失败：' + ((data && data.error) ? data.error : '未知错误'));
                    }
                } catch(e) {
                    alert('修改失败：' + (e.message || '网络错误'));
                }
            });

            const logoutButton = document.createElement('button');
            logoutButton.textContent = '登出';
            logoutButton.style.padding = '4px 8px';
            logoutButton.style.backgroundColor = '#e74c3c';
            logoutButton.style.color = 'white';
            logoutButton.style.border = 'none';
            logoutButton.style.borderRadius = '4px';
            logoutButton.style.fontSize = '0.75rem';
            logoutButton.style.cursor = 'pointer';
            logoutButton.addEventListener('click', function() { clearAccess(); location.reload(); });

            userInfo.appendChild(roleSpan);
            userInfo.appendChild(nicknameSpan);
            userInfo.appendChild(editNickBtn);
            userInfo.appendChild(changePwdBtn);
            userInfo.appendChild(logoutButton);
            document.body.appendChild(userInfo);

            // 加载昵称（CloudBase）
            (function(){
                const u = getLocalUser();
                if (!u) { nicknameSpan.textContent = '昵称: (未登录)'; return; }
                nicknameSpan.textContent = `昵称: ${u.nickname || '(未设置)'}`;
            })();
        }

        // 创建登录表单
        function createLoginForm() {
            // 清空页面内容
            document.body.innerHTML = '';
            
            // 设置登录页面样式
            document.body.style.backgroundColor = '#f5f5f5';
            document.body.style.display = 'flex';
            document.body.style.flexDirection = 'column';
            document.body.style.justifyContent = 'center';
            document.body.style.alignItems = 'center';
            document.body.style.minHeight = '100vh';
            document.body.style.margin = '0';
            document.body.style.padding = '0';
            document.body.style.boxSizing = 'border-box';
            
            // 创建登录容器
            const loginContainer = document.createElement('div');
            loginContainer.style.width = '100%';
            loginContainer.style.maxWidth = '400px';
            loginContainer.style.padding = '2rem';
            loginContainer.style.backgroundColor = 'white';
            loginContainer.style.borderRadius = '8px';
            loginContainer.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
            loginContainer.style.textAlign = 'center';
            
            // 创建标题
            const title = document.createElement('h1');
            title.textContent = '私人小说库';
            title.style.color = '#3a7bd5';
            title.style.marginBottom = '1.5rem';
            title.style.fontSize = '1.8rem';
            
            // 创建描述
            const description = document.createElement('p');
            description.textContent = '请登录以继续';
            description.style.color = '#666';
            description.style.marginBottom = '2rem';
            
            // 创建表单
            const form = document.createElement('form');
            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                try {
                    // 服务端校验：通过云函数验证用户名与密码（不在前端硬编码）
                    if (!username || !password) { throw new Error('请输入用户名与密码'); }
                    // 名单限制与密码校验交由后端完成；前端仅收集凭据

                    const auth = window.cloudbaseAuth;

                    // 自定义登录：调用云函数 HTTP 入口，后端校验用户名与密码并签发票据
                    let signedIn = false;
                    let serverUser = null;
                    try {
                        if (auth && typeof auth.signInWithCustomTicket === 'function') {
                            const envId = window.CLOUDBASE_ENV_ID;
                            let endpoint = window.cloudbaseAuthEndpoint || window.cloudbaseCustomTicketEndpoint;
                            if (!endpoint && envId) { endpoint = `https://${envId}.ap-shanghai.app.tcloudbase.com/auth`; }
                            if (!endpoint) { throw new Error('登录接口未配置，请设置 window.cloudbaseAuthEndpoint 或 cloudbaseCustomTicketEndpoint'); }
                            const tRes = await fetch(endpoint, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ action: 'login', data: { username, password } })
                            });
                            const tJson = await tRes.json();
                            if (tJson && tJson.success && tJson.token) {
                                await auth.signInWithCustomTicket(tJson.token);
                                signedIn = true;
                                serverUser = tJson.user || { uid: username };
                            } else {
                                throw new Error((tJson && tJson.error) ? tJson.error : '登录失败');
                            }
                        }
                    } catch (e) { console.warn('自定义登录失败', e); }

                    if (!signedIn) { throw new Error('用户名或密码错误'); }

                    // 持久化并刷新（前端不直接读写 users 集合）
                    localStorage.setItem('currentUser', JSON.stringify(serverUser));
                    location.reload();
                    return;
                } catch (err) {
                    console.error('登录失败', err);
                    document.getElementById('errorMessage').textContent = (err && err.message) ? err.message : '登录失败，请检查账户或网络';
                    setTimeout(function() { document.getElementById('errorMessage').textContent = ''; }, 3000);
                }
            });
            
            // 创建用户名输入框
            const usernameContainer = document.createElement('div');
            usernameContainer.style.marginBottom = '1.5rem';
            
            const usernameLabel = document.createElement('label');
            usernameLabel.textContent = '用户名（必填）';
            usernameLabel.htmlFor = 'username';
            usernameLabel.style.display = 'block';
            usernameLabel.style.textAlign = 'left';
            usernameLabel.style.color = '#333';
            usernameLabel.style.marginBottom = '0.5rem';
            
            const usernameInput = document.createElement('input');
            usernameInput.type = 'text';
            usernameInput.id = 'username';
            usernameInput.placeholder = '请输入用户名';
            usernameInput.style.width = '100%';
            usernameInput.style.padding = '0.75rem';
            usernameInput.style.border = '1px solid #ddd';
            usernameInput.style.borderRadius = '4px';
            usernameInput.style.backgroundColor = 'white';
            usernameInput.style.color = '#333';
            usernameInput.style.fontSize = '1rem';
            
            usernameInput.addEventListener('focus', function() {
                usernameInput.style.borderColor = '#3a7bd5';
            });
            
            usernameInput.addEventListener('blur', function() {
                usernameInput.style.borderColor = '#ddd';
            });
            
            usernameContainer.appendChild(usernameLabel);
            usernameContainer.appendChild(usernameInput);
            
            // 创建密码输入框
            const passwordContainer = document.createElement('div');
            passwordContainer.style.marginBottom = '1.5rem';
            
            const passwordLabel = document.createElement('label');
            passwordLabel.textContent = '密码（必填）';
            passwordLabel.htmlFor = 'password';
            passwordLabel.style.display = 'block';
            passwordLabel.style.textAlign = 'left';
            passwordLabel.style.color = '#333';
            passwordLabel.style.marginBottom = '0.5rem';
            
            const passwordInput = document.createElement('input');
            passwordInput.type = 'password';
            passwordInput.id = 'password';
            passwordInput.placeholder = '请输入密码';
            passwordInput.style.width = '100%';
            passwordInput.style.padding = '0.75rem';
            passwordInput.style.border = '1px solid #ddd';
            passwordInput.style.borderRadius = '4px';
            passwordInput.style.backgroundColor = 'white';
            passwordInput.style.color = '#333';
            passwordInput.style.fontSize = '1rem';
            passwordInput.setAttribute('autocomplete', 'off');
            
            passwordInput.addEventListener('focus', function() {
                passwordInput.style.borderColor = '#3a7bd5';
            });
            
            passwordInput.addEventListener('blur', function() {
                passwordInput.style.borderColor = '#ddd';
            });
            
            passwordContainer.appendChild(passwordLabel);
            passwordContainer.appendChild(passwordInput);
            
            // 创建错误信息
            const errorMessage = document.createElement('div');
            errorMessage.id = 'errorMessage';
            errorMessage.style.color = '#e74c3c';
            errorMessage.style.fontSize = '0.875rem';
            errorMessage.style.marginTop = '0.5rem';
            
            // 创建提交按钮
            const submitButton = document.createElement('button');
            submitButton.type = 'submit';
            submitButton.textContent = '登录';
            submitButton.style.width = '100%';
            submitButton.style.padding = '0.75rem';
            submitButton.style.backgroundColor = '#3a7bd5';
            submitButton.style.color = 'white';
            submitButton.style.border = 'none';
            submitButton.style.borderRadius = '4px';
            submitButton.style.fontSize = '1rem';
            submitButton.style.cursor = 'pointer';
            submitButton.style.transition = 'background-color 0.3s';
            
            submitButton.addEventListener('mouseenter', function() {
                submitButton.style.backgroundColor = '#00d2ff';
            });
            
            submitButton.addEventListener('mouseleave', function() {
                submitButton.style.backgroundColor = '#3a7bd5';
            });
            
            // 切换：登录 / 注册（邀请码）
            const switchContainer = document.createElement('div');
            switchContainer.style.display = 'flex';
            switchContainer.style.justifyContent = 'center';
            switchContainer.style.gap = '12px';
            switchContainer.style.marginBottom = '1rem';

            const btnLogin = document.createElement('button');
            btnLogin.type = 'button';
            btnLogin.textContent = '登录';
            btnLogin.style.padding = '6px 12px';
            btnLogin.style.border = '1px solid #3a7bd5';
            btnLogin.style.backgroundColor = '#3a7bd5';
            btnLogin.style.color = 'white';
            btnLogin.style.borderRadius = '4px';

            // 已移除注册按钮（仅保留登录）
            switchContainer.appendChild(btnLogin);

            // 已移除注册表单（静态站点不支持注册）

            // 切换逻辑（仅登录）
            btnLogin.addEventListener('click', function(){
                form.style.display = 'block';
                btnLogin.style.backgroundColor = '#3a7bd5'; btnLogin.style.color = 'white';
            });

            // 默认显示登录
            form.style.display = 'block';
            
            // 组装表单
            form.appendChild(usernameContainer);
            form.appendChild(passwordContainer);
            form.appendChild(errorMessage);
            form.appendChild(submitButton);
            
            // 组装登录容器
            loginContainer.appendChild(title);
            loginContainer.appendChild(description);
            loginContainer.appendChild(switchContainer);
            loginContainer.appendChild(form);
            
            // 添加到页面
            document.body.appendChild(loginContainer);
            window.showLoginForm = createLoginForm;
        }

        // 初始化访问控制
        function initAccessControl() {
            if (accessControl.enabled) {
                const hasAccess = checkAccess();
                if (!hasAccess) {
                    createLoginForm();
                } else {
                    // 显示用户信息
                    showUserInfo();
                    
                    // 根据用户权限显示/隐藏内容
                    applyPermissionControls();
                }
            }
        }

        // 应用权限控制到页面元素
        function applyPermissionControls() {
            // 根据权限显示/隐藏特定元素
            document.querySelectorAll('[data-permission]').forEach(element => {
                const requiredPermission = element.getAttribute('data-permission');
                if (!hasPermission(requiredPermission)) {
                    element.style.display = 'none';
                }
            });
        }

        // 页面加载时初始化访问控制
        window.addEventListener('DOMContentLoaded', initAccessControl);
        
        // 暴露API给其他脚本使用
        window.auth = {
            hasPermission,
            getCurrentUser,
            clearAccess
        };
    </script>
    <style>
        :root {
          --primary-color: #3a7bd5;
          --secondary-color: #00d2ff;
          --text-color: #333;
          --light-text: #666;
          --background-color: #fff;
          --card-bg: #f9f9f9;
          --border-color: #eee;
          --hover-bg: #f0f8ff;
        }
        
        * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
        }
        
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
          line-height: 1.6;
          color: var(--text-color);
          background-color: var(--background-color);
          max-width: 900px;
          margin: 0 auto;
          padding: 20px;
        }
        
        header {
          border-bottom: 1px solid var(--border-color);
          padding-bottom: 20px;
          margin-bottom: 30px;
        }
        
        header h1 {
          color: var(--primary-color);
          margin-bottom: 10px;
        }
        
        header p {
          color: var(--light-text);
        }
        
        nav {
          margin-bottom: 30px;
        }
        
        nav ul {
          list-style: none;
          display: flex;
          gap: 25px;
          flex-wrap: wrap;
        }
        
        nav a {
          text-decoration: none;
          color: var(--primary-color);
          font-weight: 500;
          padding: 8px 0;
          border-bottom: 2px solid transparent;
          transition: all 0.3s ease;
        }
        
        nav a:hover {
          border-bottom-color: var(--primary-color);
        }
        
        main {
          min-height: 500px;
        }
        
        h1, h2, h3 {
          margin-bottom: 20px;
          line-height: 1.3;
        }
        
        h1 {
          font-size: 2.2rem;
        }
        
        h2 {
          font-size: 1.8rem;
          margin-top: 40px;
          color: var(--primary-color);
        }
        
        h3 {
          font-size: 1.4rem;
          margin-top: 30px;
        }
        
        p {
          margin-bottom: 20px;
        }
        
        a {
          color: var(--primary-color);
          text-decoration: none;
          transition: color 0.3s ease;
        }
        
        a:hover {
          color: var(--secondary-color);
        }
        
        /* 小说集样式 */
        .novel-collections {
          margin-top: 30px;
        }
        
        .collection-list {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
          gap: 20px;
          margin-top: 20px;
        }
        
        .collection-item {
          background-color: var(--card-bg);
          padding: 20px;
          border-radius: 8px;
          transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .collection-item:hover {
          transform: translateY(-5px);
          box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .collection-item h2 {
          margin-top: 0;
          font-size: 1.5rem;
        }
        
        /* 分卷样式 */
        .volume-list {
          margin-top: 20px;
        }
        
        .volume-item {
          background-color: var(--card-bg);
          padding: 20px;
          border-radius: 8px;
          margin-bottom: 20px;
          transition: background-color 0.3s ease;
        }
        
        .volume-item:hover {
          background-color: var(--hover-bg);
        }
        
        /* 章节样式 */
        .chapter-list {
          margin-top: 20px;
        }
        
        .chapter-item {
          padding: 15px 0;
          border-bottom: 1px solid var(--border-color);
          transition: padding-left 0.3s ease;
        }
        
        .chapter-item:hover {
          padding-left: 10px;
        }
        
        .chapter-item:last-child {
          border-bottom: none;
        }
        
        .chapter-item .date {
          color: var(--light-text);
          font-size: 0.9rem;
          margin-top: 5px;
        }
        
        /* 文章样式 */
        .article {
          margin-top: 30px;
        }
        
        .article-meta {
          display: flex;
          gap: 20px;
          color: var(--light-text);
          margin-bottom: 20px;
          font-size: 0.9rem;
        }
        
        .article-content {
          margin-top: 30px;
        }
        
        .article-content h2 {
          margin-top: 40px;
          margin-bottom: 20px;
        }
        
        .article-content h3 {
          margin-top: 30px;
          margin-bottom: 15px;
        }
        
        .article-content p {
          margin-bottom: 20px;
          text-align: justify;
        }
        
        /* 导航样式 */
        .post-nav {
          display: flex;
          justify-content: space-between;
          margin-top: 40px;
          padding-top: 20px;
          border-top: 1px solid var(--border-color);
        }
        
        .next-volume, .prev-volume, .next-chapter, .prev-chapter {
          padding: 10px 15px;
          background-color: var(--card-bg);
          border-radius: 5px;
          display: inline-block;
          margin: 10px 0;
        }
        
        .back-to-collection, .back-to-volume {
          margin-top: 20px;
          text-align: center;
        }
        
        .back-to-collection a, .back-to-volume a {
          display: inline-block;
          padding: 10px 20px;
          background-color: var(--primary-color);
          color: white;
          border-radius: 5px;
          transition: background-color 0.3s ease;
        }
        
        .back-to-collection a:hover, .back-to-volume a:hover {
          background-color: var(--secondary-color);
          color: white;
        }
        
        /* 最新更新样式 */
        .latest-updates {
          margin-top: 20px;
        }
        
        .update-item {
          padding: 15px 0;
          border-bottom: 1px solid var(--border-color);
        }
        
        .update-item:last-child {
          border-bottom: none;
        }
        
        .update-item .meta {
          color: var(--light-text);
          font-size: 0.9rem;
          margin-top: 5px;
        }
        
        footer {
          margin-top: 60px;
          padding-top: 30px;
          border-top: 1px solid var(--border-color);
          text-align: center;
          color: var(--light-text);
          font-size: 0.9rem;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
          h1 {
            font-size: 1.8rem;
          }
          
          h2 {
            font-size: 1.5rem;
          }
          
          h3 {
            font-size: 1.2rem;
          }
          
          .collection-list {
            grid-template-columns: 1fr;
          }
          
          .post-nav {
            flex-direction: column;
            gap: 10px;
          }
          
          .article-meta {
            flex-direction: column;
            gap: 5px;
          }
        }
    </style>
</head>
<body>
    {{ partial "header.html" . }}
    {{ partial "nav.html" . }}
    <main>
        {{ block "main" . }}{{ end }}
    </main>
    {{ partial "footer.html" . }}
    
    <!-- 前端上传器 -->
    <div id="uploader-float-btn" style="display: none; position: fixed; bottom: 30px; right: 30px; z-index: 1000;">
        <button id="show-uploader-btn" style="width: 60px; height: 60px; border-radius: 50%; background-color: var(--primary-color); color: white; border: none; font-size: 24px; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.2); transition: all 0.3s ease;">
            +
        </button>
    </div>
    
    <!-- 上传器模态框 -->
    <div id="uploader-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1001; justify-content: center; align-items: center;">
        <div id="uploader-container" style="background-color: white; border-radius: 8px; padding: 20px; width: 100%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--text-color); margin: 0;">内容上传</h2>
                <button id="close-uploader-btn" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--light-text);">×</button>
            </div>
            
            <form id="upload-form">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-color);">上传类型</label>
                    <select id="upload-type" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;">
                        <option value="chapter">章节</option>
                        <option value="volume">分卷</option>
                        <option value="collection">小说集</option>
                        <option value="discussion">讨论贴</option>
                        <option value="image">图片</option>
                    </select>
                </div>
                
                <div id="collection-fields" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-color);">小说集名称</label>
                    <input type="text" id="collection-name" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;">
                </div>
                
                <div id="volume-fields" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-color);">分卷名称</label>
                    <input type="text" id="volume-name" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;">
                </div>
                
                <div id="chapter-fields" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-color);">章节标题</label>
                    <input type="text" id="chapter-title" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;">
                </div>
                
                <div id="discussion-fields" style="margin-bottom: 15px; display: none;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-color);">讨论标题</label>
                    <input type="text" id="discussion-title" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;">
                </div>
                
                <div id="image-fields" style="margin-bottom: 15px; display: none;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-color);">图片上传</label>
                    <div id="image-drop-zone" style="border: 2px dashed var(--border-color); border-radius: 6px; padding: 20px; text-align: center; color: var(--light-text); cursor: pointer;">
                        拖拽图片到此或点击选择文件
                        <input type="file" id="image-file" accept="image/*" style="display:none;" />
                    </div>
                    <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
                        <input type="text" id="image-folder" placeholder="static/images 或子目录，如 static/images/covers" style="flex:1; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;">
                        <button id="choose-image-btn" type="button" style="padding:8px 12px; border:1px solid var(--border-color); background:#f5f5f5; border-radius:4px; cursor:pointer;">选择图片</button>
                    </div>
                    <div id="image-preview-wrap" style="margin-top:10px; display:none;">
                         <img id="image-preview" src="" alt="预览" style="max-width:100%; max-height:200px; border:1px solid var(--border-color); border-radius:4px;" />
                     </div>
                     <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
                         <label style="display:flex; align-items:center; gap:6px; color: var(--text-color);"><input type="checkbox" id="compress-webp" checked /> 压缩为 WebP(质量 0.8)</label>
                         <label style="display:flex; align-items:center; gap:6px; color: var(--text-color);"><input type="checkbox" id="keep-original" /> 保留原图</label>
                         <button id="copy-image-url-btn" type="button" style="padding:6px 10px; border:1px solid var(--border-color); background:#f5f5f5; border-radius:4px; cursor:pointer; display:none;">复制图片链接</button>
                     </div>
                     <div id="image-progress" style="margin-top:8px; color: var(--light-text);">推荐使用 WebP 格式以降低体积</div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-color);">内容（支持Markdown格式）</label>
                    <textarea id="content" rows="10" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-color);">标签（用逗号分隔）</label>
                    <input type="text" id="tags" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;" placeholder="如：冒险, 科幻, 悬疑">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-color);">是否为草稿</label>
                    <input type="checkbox" id="draft" style="margin-right: 10px;">
                    <span style="color: var(--light-text);">勾选表示保存为草稿</span>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-color);">是否公开</label>
                    <input type="checkbox" id="is-public" style="margin-right: 10px;">
                    <span style="color: var(--light-text);">勾选表示公开内容（默认私密，仅登录可见）</span>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1; padding: 12px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">保存内容</button>
                </div>
            </form>
            
            <div id="upload-status" style="margin-top: 20px; text-align: center;"></div>
        </div>
    </div>
    
    <!-- 管理员页面快捷操作（当前页面 Front Matter） -->
    <div id="admin-quick-actions" data-permission="write" style="display: none; position: fixed; bottom: 30px; left: 30px; z-index: 1000; background: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.15);">
        <div style="font-weight: 600; margin-bottom: 8px;">页面快捷操作</div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
            <button id="enable-comments" style="padding: 8px 10px; background: #27ae60; color: #fff; border: none; border-radius: 4px; cursor: pointer;">开启评论</button>
            <button id="disable-comments" style="padding: 8px 10px; background: #c0392b; color: #fff; border: none; border-radius: 4px; cursor: pointer;">关闭评论</button>
            <input id="card-title" placeholder="卡片标题" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
            <input id="card-url" placeholder="卡片URL" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
            <input id="card-image" placeholder="卡片图片（可选）" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
            <button id="add-card" style="padding: 8px 10px; background: var(--primary-color); color: #fff; border: none; border-radius: 4px; cursor: pointer;">添加卡片</button>
            <button id="open-discussion" style="padding: 8px 10px; background: #2980b9; color: #fff; border: none; border-radius: 4px; cursor: pointer;">本页讨论</button>
            <!-- 批量生成邀请码（管理员） -->
            <input id="invite-count" type="number" min="1" max="500" placeholder="数量(默认10)" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; width: 120px;">
            <input id="invite-days" type="number" min="1" max="3650" placeholder="有效天数(默认30)" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; width: 140px;">
            <input id="invite-role" placeholder="角色(默认reader)" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; width: 150px;">
            <input id="invite-perms" placeholder='权限JSON(默认["read"])' style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; width: 180px;">
            <input id="invite-assigned" placeholder="绑定ID(可选)" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; width: 150px;">
            <button id="generate-invites" style="padding: 8px 10px; background: #8e44ad; color: #fff; border: none; border-radius: 4px; cursor: pointer;">批量生成邀请码</button>
        </div>
        <div id="admin-action-status" style="margin-top: 8px; font-size: 0.9rem; color: var(--light-text);"></div>
        <textarea id="invite-output" readonly style="display:none; margin-top: 8px; width: 100%; height: 120px; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace;" placeholder="生成的邀请码将显示在此，按行分隔"></textarea>
    </div>
    <div id="current-md-path" data-path="{{ with .File }}{{ .Path }}{{ else }}{{ "" }}{{ end }}" style="display:none;"></div>
     <div id="site-mode" data-offline="{{ if .Site.Params.offline }}true{{ else }}false{{ end }}" style="display:none;"></div>
     <script>
         // 当前页面对应的 Markdown 路径（如果可用）
         window.CURRENT_MD_PATH = document.getElementById('current-md-path')?.dataset.path || "";
         
         // 管理员快捷操作逻辑
        document.addEventListener('DOMContentLoaded', function() {
            const user = getLocalUser();
            const panel = document.getElementById('admin-quick-actions');
            const statusEl = document.getElementById('admin-action-status');
            const OFFLINE = document.getElementById('site-mode')?.dataset.offline === 'true';
            if (OFFLINE) { if (panel) panel.style.display = 'none'; return; }
            if (user && hasPermission('write')) {
                panel.style.display = 'block';
                const adminControls = ['invite-count','invite-days','invite-role','invite-perms','invite-assigned','generate-invites','invite-output'];
                if (!hasPermission('admin')) { adminControls.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; }); }
            }
            async function callUpdate(path, action, payload, message) {
                let ok = false; let lastError = '';
                const user = getLocalUser();
                const record = { repo: 'Silent-Tiga/my-private-novel', path, action, payload, message, userId: user && user.uid ? user.uid : '', ts: Date.now() };
                try {
                    let db = null;
                    if (window.cloudbaseDb) {
                        db = window.cloudbaseDb;
                    } else if (window.cloudbase && window.cloudbase.CloudBase) {
                        const envId = window.CLOUDBASE_ENV_ID || '';
                        const app = window.cloudbase.init({ env: envId });
                        db = app.database();
                    }
                    if (db) {
                        const res = await db.collection('admin_actions').add(record);
                        ok = !!res && (!!res.id || !!res._id);
                    }
                } catch (err) {
                    lastError = err && err.message ? err.message : String(err);
                }
                if (!ok) {
                    try {
                        const arr = JSON.parse(localStorage.getItem('pendingAdminActions') || '[]');
                        arr.push(record);
                        localStorage.setItem('pendingAdminActions', JSON.stringify(arr));
                        ok = true;
                    } catch(e2) {
                        lastError = lastError || (e2 && e2.message ? e2.message : String(e2));
                    }
                }
                if (ok) {
                    statusEl.textContent = '操作已记录（CloudBase/离线队列）。';
                } else {
                    let msg = '操作失败：';
                    const err = lastError || '';
                    if (/401|403|unauthorized|Insufficient permissions/i.test(err)) {
                        msg += '权限不足，请登录或升级权限';
                    } else if (/409|conflict/i.test(err)) {
                        msg += '内容冲突，请刷新后重试';
                    } else if (/5\d{2}/.test(err)) {
                        msg += '服务器错误，请稍后重试';
                    } else if (err) {
                        msg += err;
                    } else {
                        msg += 'CloudBase 不可用且无法写入本地队列';
                    }
                    statusEl.textContent = msg;
                }
            }
            document.getElementById('enable-comments').addEventListener('click', function(){
                if (!window.CURRENT_MD_PATH) { statusEl.textContent = '当前页面无关联文件路径'; return; }
                callUpdate(window.CURRENT_MD_PATH, 'toggle_comments', { enabled: true }, 'Enable comments');
            });
            document.getElementById('disable-comments').addEventListener('click', function(){
                if (!window.CURRENT_MD_PATH) { statusEl.textContent = '当前页面无关联文件路径'; return; }
                callUpdate(window.CURRENT_MD_PATH, 'toggle_comments', { enabled: false }, 'Disable comments');
            });
            document.getElementById('add-card').addEventListener('click', function(){
                if (!window.CURRENT_MD_PATH) { statusEl.textContent = '当前页面无关联文件路径'; return; }
                const title = document.getElementById('card-title').value.trim();
                const url = document.getElementById('card-url').value.trim();
                const image = document.getElementById('card-image').value.trim();
                if (!title || !url) { statusEl.textContent = '请填写卡片标题与URL'; return; }
                callUpdate(window.CURRENT_MD_PATH, 'set_cards', { cards: [{ title, url, image }] }, 'Add card');
            });
            // 本页讨论一键入口：确保讨论条目存在，若不存在则创建并跳转
            document.getElementById('open-discussion').addEventListener('click', async function(){
                try {
                    const baseSlugSrc = window.CURRENT_MD_PATH || window.location.pathname;
                    const slug = slugify(baseSlugSrc || 'page');
                    const mdPath = `content/forum/discussion/${slug}.md`;
                    const title = `讨论：${document.title || slug}`;
                    const payload = { frontmatter: { title, type: 'discussion', tags: ['页面'], related: window.CURRENT_MD_PATH || window.location.pathname, draft: false }, content: `本页（${baseSlugSrc}）的讨论入口。` };
                    await callUpdate(mdPath, 'create_entry', payload, 'Ensure page discussion');
                    const targetUrl = `/forum/discussion/${slug}/`;
                    window.location.href = targetUrl;
                } catch(e) {
                    statusEl.textContent = `打开讨论失败：${e.message}`;
                }
            });
            // 批量生成邀请码
            const genBtn = document.getElementById('generate-invites');
            if (genBtn) {
                genBtn.addEventListener('click', async function() {
                    const count = Number(document.getElementById('invite-count').value || '');
                    const expDays = Number(document.getElementById('invite-days').value || '');
                    const role = (document.getElementById('invite-role').value || '').trim();
                    const permsStr = (document.getElementById('invite-perms').value || '').trim();
                    const assignedId = (document.getElementById('invite-assigned').value || '').trim();
                    let permissions = null;
                    if (permsStr) {
                        try { permissions = JSON.parse(permsStr); if (!Array.isArray(permissions)) throw new Error('权限必须是数组'); }
                        catch (e) { alert('权限JSON不合法'); return; }
                    }
                    const payload = {};
                    if (count) payload.count = Math.max(1, Math.min(500, count));
                    if (expDays) payload.expDays = Math.max(1, Math.min(3650, expDays));
                    if (role) payload.role = role;
                    if (permissions) payload.permissions = permissions;
                    if (assignedId) payload.assignedId = assignedId;
                    let ok = false; let lastError = '';
                    try {
                        const user = getLocalUser();
                        const record = { action: 'create_invites', payload, userId: user && user.uid ? user.uid : '', ts: Date.now() };
                        if (window.cloudbaseDb) {
                            try {
                                const res = await window.cloudbaseDb.collection('admin_actions').add(record);
                                ok = !!res && (!!res.id || !!res._id);
                            } catch (e) { lastError = e.message || String(e); }
                        }
                        if (!ok) {
                            try {
                                const arr = JSON.parse(localStorage.getItem('pendingAdminActions') || '[]');
                                arr.push(record);
                                localStorage.setItem('pendingAdminActions', JSON.stringify(arr));
                                ok = true;
                            } catch (e) { lastError = lastError || (e.message || String(e)); }
                        }
                    } catch (e) { lastError = e.message || String(e); }
                    if (ok) {
                        statusEl.textContent = '已记录邀请码生成请求（CloudBase/离线队列）。';
                        const output = document.getElementById('invite-output');
                        output.value = '请求已记录，等待后台处理生成具体邀请码';
                        output.style.display = 'block';
                    } else {
                        statusEl.textContent = `生成失败：${lastError || 'CloudBase 不可用且无法写入本地队列'}`;
                    }
                });
            }
        });
    </script>
    <script>
        // 初始化上传器
        function initUploader() {
            const OFFLINE = document.getElementById('site-mode')?.dataset.offline === 'true';
            if (OFFLINE) { return; }
            const user = getLocalUser();
            const floatBtn = document.getElementById('uploader-float-btn');
            const modal = document.getElementById('uploader-modal');
            const showBtn = document.getElementById('show-uploader-btn');
            const closeBtn = document.getElementById('close-uploader-btn');
            const uploadForm = document.getElementById('upload-form');
            const uploadType = document.getElementById('upload-type');
            const collectionFields = document.getElementById('collection-fields');
            const volumeFields = document.getElementById('volume-fields');
            const chapterFields = document.getElementById('chapter-fields');
            const discussionFields = document.getElementById('discussion-fields');
            const imageFields = document.getElementById('image-fields');
            const imageFile = document.getElementById('image-file');
            const imageFolder = document.getElementById('image-folder');
            const imageDropZone = document.getElementById('image-drop-zone');
            const imagePreviewWrap = document.getElementById('image-preview-wrap');
            const imagePreview = document.getElementById('image-preview');
            const imageProgress = document.getElementById('image-progress');
             const compressWebp = document.getElementById('compress-webp');
             const keepOriginal = document.getElementById('keep-original');
             const copyImageUrlBtn = document.getElementById('copy-image-url-btn');
             const uploadStatus = document.getElementById('upload-status');
            
            // 检查用户是否有写权限
            if (user && hasPermission('write')) {
                floatBtn.style.display = 'block';
            }
            
            // 根据上传类型显示/隐藏相应的字段
            function toggleUploadFields() {
                const type = uploadType.value;
                
                collectionFields.style.display = (type === 'volume' || type === 'chapter') ? 'block' : 'none';
                volumeFields.style.display = type === 'chapter' ? 'block' : 'none';
                chapterFields.style.display = type === 'chapter' ? 'block' : 'none';
                discussionFields.style.display = type === 'discussion' ? 'block' : 'none';
                imageFields.style.display = type === 'image' ? 'block' : 'none';
            }
            
            // 显示上传器
            showBtn.addEventListener('click', function() {
                modal.style.display = 'flex';
                toggleUploadFields();
            });
            
            // 关闭上传器
            closeBtn.addEventListener('click', function() {
                modal.style.display = 'none';
                uploadStatus.innerHTML = '';
                uploadForm.reset();
            });
            
            // 点击模态框背景关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    uploadStatus.innerHTML = '';
                    uploadForm.reset();
                }
            });
            
            // 监听上传类型变化
            uploadType.addEventListener('change', toggleUploadFields);
            
            // 图片上传交互
            document.getElementById('choose-image-btn').addEventListener('click', () => imageFile.click());
            imageDropZone.addEventListener('click', () => imageFile.click());
            imageDropZone.addEventListener('dragover', (e) => { e.preventDefault(); imageDropZone.style.borderColor = '#888'; });
            imageDropZone.addEventListener('dragleave', () => { imageDropZone.style.borderColor = 'var(--border-color)'; });
            function handleSelectedFile(file) {
                 const reader = new FileReader();
                 reader.onload = () => {
                     const dataUrl = reader.result;
                     imagePreview.src = dataUrl;
                     imagePreviewWrap.style.display = 'block';
                     const img = new Image();
                     img.onload = () => {
                         const sizeMB = (file.size/1024/1024).toFixed(2);
                         imageProgress.textContent = `已选择：${file.name} ${img.naturalWidth}x${img.naturalHeight} (${sizeMB}MB)`;
                     };
                     img.src = dataUrl;
                 };
                 reader.readAsDataURL(file);
             }
             imageDropZone.addEventListener('drop', (e) => {
                 e.preventDefault();
                 imageDropZone.style.borderColor = 'var(--border-color)';
                 if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                     imageFile.files = e.dataTransfer.files;
                     handleSelectedFile(imageFile.files[0]);
                 }
             });
             imageDropZone.addEventListener('paste', (e) => {
                 const items = e.clipboardData && e.clipboardData.items;
                 if (!items) return;
                 for (const it of items) {
                     if (it.type && it.type.startsWith('image/')) {
                         const file = it.getAsFile();
                         if (file) { imageFile.files = new DataTransfer().files; /* placeholder to keep state */ handleSelectedFile(file); }
                         break;
                     }
                 }
             });
             imageFile.addEventListener('change', () => {
                 const file = imageFile.files[0];
                 if (!file) return;
                 handleSelectedFile(file);
             });
            
            // 处理表单提交
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 获取表单数据
                const type = uploadType.value;
                const collectionName = document.getElementById('collection-name').value.trim();
                const volumeName = document.getElementById('volume-name').value.trim();
                const chapterTitle = document.getElementById('chapter-title').value.trim();
                const discussionTitle = document.getElementById('discussion-title').value.trim();
                const content = document.getElementById('content').value.trim();
                const tags = document.getElementById('tags').value.trim();
                const isDraft = document.getElementById('draft').checked;
                const isPublic = document.getElementById('is-public').checked;
                
                // 图片上传专用处理
                if (type === 'image') {
                     const file = imageFile && imageFile.files && imageFile.files[0];
                     if (!file) {
                         uploadStatus.innerHTML = '<span style="color: red;">请选择要上传的图片文件</span>';
                         return;
                     }
                     if (file.size > 5 * 1024 * 1024) { // 5MB 限制
                         uploadStatus.innerHTML = '<span style="color: red;">图片大小不能超过 5MB</span>';
                         return;
                     }
                     const allowed = ['image/png', 'image/jpeg', 'image/webp', 'image/gif'];
                     if (!allowed.includes(file.type)) {
                         uploadStatus.innerHTML = '<span style="color: red;">仅支持 PNG/JPEG/WebP/GIF 格式图片</span>';
                         return;
                     }
                     const folder = (imageFolder && imageFolder.value.trim()) || 'static/images';
                     const submitBtn = uploadForm.querySelector('button[type="submit"]');
                     submitBtn && (submitBtn.disabled = true);
                     uploadStatus.innerHTML = '<span style="color: var(--primary-color);">正在上传图片...</span>';
                     const reader = new FileReader();
                     reader.onload = async () => {
                         try {
                             const dataUrl = reader.result;
                             const user = getLocalUser();
                             if (!user || !hasPermission('write')) {
                                 uploadStatus.innerHTML = '<span style="color: red;">未登录或无写权限，请先登录</span>';
                                 submitBtn && (submitBtn.disabled = false);
                                 return;
                             }
                             // 统一重命名规则: timestamp-slug.ext
                             const extFromType = (() => {
                                 if (compressWebp.checked && (file.type === 'image/jpeg' || file.type === 'image/png')) return 'webp';
                                 const map = { 'image/png': 'png', 'image/jpeg': 'jpg', 'image/webp': 'webp', 'image/gif': 'gif' };
                                 return map[file.type] || 'png';
                             })();
                             const baseName = file.name.replace(/\.[^.]+$/, '');
                             const nameSlug = (s => s.toLowerCase().trim().replace(/\s+/g,'-').replace(/[^\p{L}\p{N}\-]+/gu,'').replace(/-+/g,'-').replace(/^-+|-+$/g,''))(baseName) || ('untitled');
                             const ts = new Date().toISOString().slice(0,19).replace(/[-:T]/g,'');
                             const finalName = `${ts}-${nameSlug}.${extFromType}`;
                             
                             // 压缩为 WebP（仅 jpeg/png）
                             async function prepareBlob() {
                                 if (compressWebp.checked && (file.type === 'image/jpeg' || file.type === 'image/png')) {
                                     const img = await new Promise((resolve) => { const i = new Image(); i.onload = () => resolve(i); i.src = dataUrl; });
                                     const canvas = document.createElement('canvas');
                                     canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
                                     const ctx = canvas.getContext('2d');
                                     ctx.drawImage(img, 0, 0);
                                     const webpDataUrl = canvas.toDataURL('image/webp', 0.8);
                                     const b64 = webpDataUrl.split(',')[1];
                                     const res = await fetch(webpDataUrl);
                                     const blob = await res.blob();
                                     return { blob, base64: b64 };
                                 } else {
                                     const b64 = dataUrl.split(',')[1];
                                     const res = await fetch(dataUrl);
                                     const blob = await res.blob();
                                     return { blob, base64: b64 };
                                 }
                             }
                             async function sha256Hex(blob) {
                                 const buf = await blob.arrayBuffer();
                                 const digest = await crypto.subtle.digest('SHA-256', buf);
                                 const view = new Uint8Array(digest);
                                 return Array.from(view).map(b => b.toString(16).padStart(2,'0')).join('');
                             }
                             const prepared = await prepareBlob();
                             const shaHex = await sha256Hex(prepared.blob);
                             const body = {
                                 file_base64: prepared.base64,
                                 folder,
                                 filename: finalName,
                                 sha256: shaHex
                             };
                             let ok = false; let lastError = '';
                             try {
                                 if (window.cloudbaseDb) {
                                     const rec = { type: 'image', folder, filename: finalName, sha256: shaHex, file_base64: prepared.base64, ts: Date.now() };
                                     const res = await window.cloudbaseDb.collection('uploads').add(rec);
                                     ok = !!res && (!!res.id || !!res._id);
                                 }
                                 if (!ok) {
                                     const arr = JSON.parse(localStorage.getItem('pendingUploads') || '[]');
                                     arr.push({ type: 'image', folder, filename: finalName, sha256: shaHex, file_base64: prepared.base64, ts: Date.now() });
                                     localStorage.setItem('pendingUploads', JSON.stringify(arr));
                                     ok = true;
                                 }
                             } catch (e) { lastError = e.message || String(e); }
                             if (!ok) throw new Error(lastError || 'CloudBase 不可用且无法写入本地队列');
                             imageProgress.textContent = '已记录图片上传任务（CloudBase/离线队列）';
                             copyImageUrlBtn.style.display = 'none';
                             // 保留原图（仅当已压缩且选择保留原图）
                             let ok2 = false; let lastError2 = '';
                             if (compressWebp && keepOriginal && compressWebp.checked && keepOriginal.checked && (file.type === 'image/jpeg' || file.type === 'image/png')) {
                                 try {
                                     const originalB64 = dataUrl.split(',')[1];
                                     const resOrig = await fetch(dataUrl);
                                     const originalBlob = await resOrig.blob();
                                     let originalSha = '';
                                     {
                                         const buf = await originalBlob.arrayBuffer();
                                         const digest = await crypto.subtle.digest('SHA-256', buf);
                                         const view = new Uint8Array(digest);
                                         originalSha = Array.from(view).map(b => b.toString(16).padStart(2,'0')).join('');
                                     }
                                     const origExt = file.type === 'image/jpeg' ? 'jpg' : 'png';
                                     const origName = `${ts}-${nameSlug}.${origExt}`;
                                     const body2 = { file_base64: originalB64, folder, filename: origName, sha256: originalSha };
                                     try {
                                         if (window.cloudbaseDb) {
                                             const rec2 = { type: 'image', folder, filename: origName, sha256: originalSha, file_base64: originalB64, ts: Date.now() };
                                             const res2 = await window.cloudbaseDb.collection('uploads').add(rec2);
                                             ok2 = !!res2 && (!!res2.id || !!res2._id);
                                         }
                                         if (!ok2) {
                                             const arr2 = JSON.parse(localStorage.getItem('pendingUploads') || '[]');
                                             arr2.push({ type: 'image', folder, filename: origName, sha256: originalSha, file_base64: originalB64, ts: Date.now() });
                                             localStorage.setItem('pendingUploads', JSON.stringify(arr2));
                                             ok2 = true;
                                         }
                                     } catch (e2) { lastError2 = e2.message || String(e2); }
                                     if (!ok2) { console.warn('保留原图上传失败', lastError2); }
                                 } catch (e) {
                                     console.warn('保留原图异常', e);
                                 }
                             }
                             uploadStatus.innerHTML = '<span style="color: green;">图片上传成功</span>';
                             submitBtn && (submitBtn.disabled = false);
                             // 图片成功后不自动关闭模态，方便继续编辑内容
                         } catch (err) {
                             uploadStatus.innerHTML = `<span style="color: red;">上传失败：${err.message}</span>`;
                             submitBtn && (submitBtn.disabled = false);
                         }
                     };
                     reader.readAsDataURL(file);
                     return; // 不继续执行文本内容保存逻辑
                 }
                
                // 表单验证
                if (type === 'chapter' && (!collectionName || !volumeName || !chapterTitle || !content)) {
                    uploadStatus.innerHTML = '<span style="color: red;">请填写所有必填字段</span>';
                    return;
                }
                
                if (type === 'volume' && (!collectionName || !volumeName)) {
                    uploadStatus.innerHTML = '<span style="color: red;">请填写小说集名称和分卷名称</span>';
                    return;
                }
                
                if (type === 'collection' && !collectionName) {
                    uploadStatus.innerHTML = '<span style="color: red;">请填写小说集名称</span>';
                    return;
                }
                
                if (type === 'discussion' && (!discussionTitle || !content)) {
                    uploadStatus.innerHTML = '<span style="color: red;">请填写讨论标题和内容</span>';
                    return;
                }
                
                // 显示保存状态
                uploadStatus.innerHTML = '<span style="color: var(--primary-color);">保存中...</span>';
                
                // 使用 CloudBase 发布到论坛/集合
                (async () => {
                    try {
                        const db = window.cloudbaseDb;
                        const auth = window.cloudbaseAuth;
                        if (!db || !auth || typeof auth.getCurrentUser !== 'function') {
                            throw new Error('CloudBase 未初始化或用户未登录');
                        }
                        const cu = await auth.getCurrentUser();
                        const collections = window.cloudbaseCollections || {};
                        const postsCol = collections.posts || 'posts';
                        const novelsCol = collections.novels || 'novels';
                        const now = Date.now();
                        const tagsArr = tags ? tags.split(',').map(t => t.trim()).filter(Boolean) : [];

                        const slugify = (s) => {
                            const base = (s || '').toLowerCase().trim()
                                .replace(/\s+/g, '-')
                                .replace(/[^\p{L}\p{N}\-]+/gu, '')
                                .replace(/-+/g, '-')
                                .replace(/^-+|-+$/g, '');
                            return base || ('untitled-' + now);
                        };

                        let doc = null;
                        if (type === 'discussion') {
                            doc = {
                                type: 'discussion',
                                title: discussionTitle,
                                content,
                                tags: tagsArr,
                                authorUid: cu.uid,
                                authorEmail: cu.email || '',
                                createdAt: now,
                                updatedAt: now,
                                status: isDraft ? 'draft' : 'published',
                                visibility: isPublic ? 'public' : 'private'
                            };
                            await db.collection(postsCol).add(doc);
                            uploadStatus.innerHTML = '<span style="color: green;">已发布到论坛（CloudBase）</span>';
                        } else if (type === 'collection' || type === 'volume' || type === 'chapter') {
                            const baseSlug = slugify(collectionName);
                            const volumeSlug = slugify(volumeName);
                            const chapterSlug = slugify(chapterTitle);
                            doc = {
                                type,
                                title: type === 'collection' ? collectionName : (type === 'volume' ? volumeName : chapterTitle),
                                content,
                                tags: tagsArr,
                                authorUid: cu.uid,
                                authorEmail: cu.email || '',
                                collectionSlug: baseSlug,
                                volumeSlug: volumeSlug,
                                chapterSlug: chapterSlug,
                                createdAt: now,
                                updatedAt: now,
                                status: isDraft ? 'draft' : 'published',
                                visibility: isPublic ? 'public' : 'private'
                            };
                            await db.collection(novelsCol).add(doc);
                            uploadStatus.innerHTML = '<span style="color: green;">已保存到小说集合（CloudBase）</span>';
                        } else {
                            throw new Error('不支持的类型');
                        }

                        setTimeout(function() {
                            modal.style.display = 'none';
                            uploadStatus.innerHTML = '';
                            uploadForm.reset();
                        }, 1500);
                    } catch (err) {
                        uploadStatus.innerHTML = `<span style=\"color: red;\">保存失败：${err.message}</span>`;
                    }
                })();
            });
        }
        
        // 在页面加载完成后初始化上传器
        document.addEventListener('DOMContentLoaded', function() {
            // 检查用户是否登录并有写权限
            const user = getLocalUser();
            const OFFLINE = document.getElementById('site-mode')?.dataset.offline === 'true';
            if (!OFFLINE && user && hasPermission('write')) {
                initUploader();
            }
        });
    </script>
    {{ if .Site.Params.offline }}
    <div id="login-component" style="position: fixed; bottom: 30px; right: 30px; z-index: 1000; background: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.15);">
      {{ partial "login.html" . }}
    </div>
    {{ end }}
</body>
</html>
<script>
  window.CF_MEDIA_BASE = window.CF_MEDIA_BASE || 'https://your-worker-subdomain.workers.dev';
  function getAuthJWTForMedia() {
    try {
      const user = getLocalUser();
      return (user && user.uid) ? user.uid : '';
    } catch(e) { return ''; }
  }
  function cfMediaUrl(key) {
    try {
      const base = window.CF_MEDIA_BASE || '';
      const t = getAuthJWTForMedia();
      const q = `key=${encodeURIComponent(key)}${t ? `&t=${encodeURIComponent(t)}` : ''}`;
      return `${base.replace(/\/$/, '')}/api/media/get?${q}`;
    } catch(e) { return key; }
  }
</script>